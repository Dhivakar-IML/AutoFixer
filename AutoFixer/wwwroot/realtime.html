<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoFixer - Real-Time Error Pattern Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .realtime-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .pattern-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }
        .pattern-item {
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
        }
        .confidence-high { border-left-color: #00ff00; }
        .confidence-medium { border-left-color: #ffff00; }
        .confidence-low { border-left-color: #ff6600; }
        .ml-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff00;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AutoFixer Real-Time ML Analysis</h1>
            <p><span class="realtime-indicator"></span>Live Error Pattern Detection with TF-IDF + DBSCAN</p>
        </div>

        <div class="status-grid">
            <div class="card">
                <h3>üìä Real-Time Status</h3>
                <div id="connection-status">Connecting...</div>
                <div id="last-update">Last Update: Never</div>
                <div id="processing-mode">Mode: Initializing</div>
            </div>

            <div class="card">
                <h3>üéØ ML Performance</h3>
                <div class="ml-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="confidence-score">0%</div>
                        <div>Avg Confidence</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pattern-count">0</div>
                        <div>Patterns</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processing-speed">0ms</div>
                        <div>Response Time</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="simulateError()">üö® Simulate Real-Time Error</button>
            <button onclick="startDemo()">‚ñ∂Ô∏è Start Live Demo</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="status-grid">
            <div class="card">
                <h3>üîç Live Error Patterns</h3>
                <div class="pattern-list" id="pattern-list">
                    <div style="text-align: center; color: #aaa;">Waiting for real-time data...</div>
                </div>
            </div>

            <div class="card">
                <h3>üìù Real-Time Log</h3>
                <div class="log" id="log-output">
                    <div>[System] Real-time monitoring initialized</div>
                    <div>[ML] TF-IDF pipeline ready</div>
                    <div>[ML] DBSCAN clustering engine active</div>
                    <div>[Database] MongoDB Atlas connection established</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/errorPatternHub")
            .build();

        let patternCount = 0;
        let totalConfidence = 0;
        let processingStartTime = Date.now();

        connection.start().then(function () {
            document.getElementById('connection-status').innerHTML = 
                '<span style="color: #00ff00;">‚úÖ Connected to Real-Time Stream</span>';
            addLog('[WebSocket] Connected to real-time error pattern stream');
            
            // Request initial status
            fetch('/api/RealTime/status')
                .then(response => response.json())
                .then(data => updateStatus(data));
                
        }).catch(function (err) {
            document.getElementById('connection-status').innerHTML = 
                '<span style="color: #ff0000;">‚ùå Connection Failed</span>';
            addLog('[Error] ' + err.toString());
        });

        connection.on("PatternUpdate", function (data) {
            console.log('PatternUpdate received:', data); // Debug log
            addLog(`[Real-Time] New pattern detected: ${data.newError?.name || 'Unknown'}`);
            addLog(`[ML] Analysis type: ${data.analysisType || 'N/A'}`);
            addLog(`[ML] Total patterns: ${data.totalPatterns || 0}`);
            
            if (data.highConfidencePatterns && data.highConfidencePatterns.length > 0) {
                updatePatternList(data.highConfidencePatterns);
                updateMLStats(data.highConfidencePatterns);
            }
            
            document.getElementById('last-update').textContent = 
                `Last Update: ${new Date(data.timestamp || Date.now()).toLocaleTimeString()}`;
            document.getElementById('processing-mode').textContent = 
                'Mode: Live Processing';
        });

        connection.on("DemoStarted", function (data) {
            console.log('DemoStarted received:', data); // Debug log
            addLog(`[Demo] ${data.message || 'Demo started'}`);
            document.getElementById('processing-mode').textContent = 'Mode: Demo Streaming';
        });

        function updatePatternList(patterns) {
            const listEl = document.getElementById('pattern-list');
            listEl.innerHTML = '';
            
            patterns.forEach(pattern => {
                const confidence = (pattern.confidence || pattern.Confidence || 0) * 100;
                const confidenceClass = confidence > 90 ? 'confidence-high' : 
                                       confidence > 75 ? 'confidence-medium' : 'confidence-low';
                
                const item = document.createElement('div');
                item.className = `pattern-item ${confidenceClass}`;
                item.innerHTML = `
                    <strong>${pattern.name || pattern.Name || 'Unknown'}</strong><br>
                    <small>Category: ${pattern.category || pattern.Category || 'Unknown'} | 
                    Confidence: ${confidence.toFixed(1)}% | 
                    Priority: ${pattern.priority || pattern.Priority || 'N/A'}</small><br>
                    <em>${pattern.description || pattern.Description || 'No description'}</em>
                `;
                listEl.appendChild(item);
            });
        }

        function updateMLStats(patterns) {
            if (patterns.length > 0) {
                const avgConfidence = patterns.reduce((sum, p) => sum + (p.confidence || p.Confidence || 0), 0) / patterns.length;
                document.getElementById('confidence-score').textContent = 
                    (avgConfidence * 100).toFixed(1) + '%';
            }
            
            document.getElementById('pattern-count').textContent = patterns.length;
            document.getElementById('processing-speed').textContent = 
                (Date.now() - processingStartTime) + 'ms';
            
            processingStartTime = Date.now();
        }

        function updateStatus(data) {
            console.log('Status data:', data); // Debug log
            addLog(`[Status] Total patterns in database: ${data.totalPatterns || data.TotalPatterns || 0}`);
            addLog(`[Status] Recent patterns (5min): ${data.recentPatterns || data.RecentPatterns || 0}`);
            
            const recentErrors = data.recentErrors || data.RecentErrors;
            if (recentErrors && recentErrors.length > 0) {
                recentErrors.forEach(error => {
                    const name = error.name || error.Name || 'Unknown';
                    const confidence = error.confidence || error.Confidence || 0;
                    addLog(`[Recent] ${name} - ${confidence}% confidence`);
                });
            }
        }

        function simulateError() {
            const errors = [
                { ErrorName: "Database Connection Timeout", Category: "Database", Description: "Connection pool exhausted", Priority: 1 },
                { ErrorName: "API Rate Limit Exceeded", Category: "API", Description: "429 Too Many Requests", Priority: 2 },
                { ErrorName: "Memory Leak Detected", Category: "Memory", Description: "Heap size exceeded threshold", Priority: 1 },
                { ErrorName: "Authentication Failed", Category: "Security", Description: "Invalid JWT token", Priority: 2 }
            ];
            
            const randomError = errors[Math.floor(Math.random() * errors.length)];
            
            fetch('/api/RealTime/simulate-error', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(randomError)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Simulate error response:', data); // Debug log
                addLog(`[Simulation] ${data.message || data.Message || 'Error simulated'}`);
            })
            .catch(err => addLog(`[Error] ${err.toString()}`));
        }

        function startDemo() {
            fetch('/api/RealTime/stream-demo')
                .then(response => response.json())
                .then(data => {
                    console.log('Demo data:', data); // Debug log
                    addLog(`[Demo] ${data.message || data.Message || 'Demo started'}`);
                    addLog(`[Demo] WebSocket endpoint: ${data.webSocketEndpoint || data.WebSocketEndpoint || '/errorPatternHub'}`);
                });
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }

        function addLog(message) {
            const logEl = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${time}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Auto-refresh status every 30 seconds
        setInterval(() => {
            fetch('/api/RealTime/status')
                .then(response => response.json())
                .then(data => updateStatus(data));
        }, 30000);
    </script>
</body>
</html>